generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Roles configurables con permisos por pantalla (ABM en gestión de usuarios).
model Role {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?
  permisos    Json     @default("[]") // array de códigos: "home", "comprar", "ver-compras", etc.
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  password     String
  nombre       String
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Restrict)
  compras      Compra[]
  recepciones  Recepcion[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Proveedor {
  id            String   @id @default(cuid())
  nombre        String
  codigoExterno String?  @unique
  idExterno     String?  // PK del proveedor en SQL Server (articulos.proveedor puede referenciar este id)
  compras       Compra[]
}

model Producto {
  id              String   @id @default(cuid())
  codigo          String   @unique
  codigoExterno   String?  @unique
  descripcion     String
  stockSucursales Int      @default(0)
  stockCD         Int      @default(0)
  ventasN1        Int      @default(0)
  ventasN2        Int      @default(0)
  ventas7dias     Int      @default(0)
  costo           Decimal  @default(0) @db.Decimal(12, 2)
  precioVenta     Decimal  @default(0) @db.Decimal(12, 2)
  margenPorc      Decimal  @default(0) @db.Decimal(5, 2)
  detalles        DetalleCompra[]
}

model Compra {
  id           String         @id @default(cuid())
  numeroCompra Int?           @unique // Número secuencial para trazabilidad (asignado al crear)
  fecha        DateTime       @db.Date
  totalBultos  Int            @default(0)
  totalMonto   Decimal        @default(0) @db.Decimal(14, 2)
  userId       String
  proveedorId  String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  proveedor    Proveedor      @relation(fields: [proveedorId], references: [id], onDelete: Restrict)
  detalles     DetalleCompra[]
  recepcion    Recepcion?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([fecha])
  @@index([userId])
  @@index([proveedorId])
}

model DetalleCompra {
  id                String            @id @default(cuid())
  compraId          String
  productoId        String
  bultos            Int               @default(0)
  precioPorBulto     Decimal           @default(0) @db.Decimal(12, 2)
  pesoPorBulto      Decimal           @default(0) @db.Decimal(8, 2)
  precioPorKg       Decimal           @default(0) @db.Decimal(12, 2)
  total             Decimal           @default(0) @db.Decimal(14, 2)
  compra            Compra            @relation(fields: [compraId], references: [id], onDelete: Cascade)
  producto          Producto          @relation(fields: [productoId], references: [id], onDelete: Restrict)
  detallesRecepcion DetalleRecepcion[]
}

model Recepcion {
  id              String             @id @default(cuid())
  numeroRecepcion Int?               @unique
  compraId        String             @unique
  userId          String
  completa        Boolean            @default(false) // true cuando se guardó precio de venta (fin del proceso)
  compra          Compra             @relation(fields: [compraId], references: [id], onDelete: Cascade)
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  detalles        DetalleRecepcion[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([compraId])
  @@index([userId])
  @@index([createdAt])
}

model DetalleRecepcion {
  id              String        @id @default(cuid())
  recepcionId     String
  detalleCompraId String        @unique
  cantidad        Int           @default(0)
  uxb             Int           @default(0)
  precioVenta     Decimal?      @db.Decimal(12, 2)  // Precio de venta por unidad (permite calcular MarkUP)
  margenPorc     Decimal?      @db.Decimal(5, 2)   // Margen % = (precioVenta - costo) / costo * 100
  recepcion       Recepcion     @relation(fields: [recepcionId], references: [id], onDelete: Cascade)
  detalleCompra   DetalleCompra @relation(fields: [detalleCompraId], references: [id], onDelete: Cascade)

  @@index([recepcionId])
}
